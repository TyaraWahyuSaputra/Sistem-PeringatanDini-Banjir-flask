{% extends "layout.html" %}

{% block content %}
<!-- Hero Section dengan Gambar -->
<div class="hero-section-with-image">
    <div class="hero-image-container">
        <img src="{{ url_for('static', filename='image/hero_section.jpg') }}" 
            alt="Laporan Bulanan" 
            class="hero-image">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="hero-title">LAPORAN BULANAN</h1>
            <p class="hero-subtitle">
                Rekapitulasi Laporan Banjir - {{ now.strftime('%B %Y') }}
            </p>
            <div class="hero-actions">
                <a href="{{ url_for('catatan_laporan') }}" class="btn btn-secondary">
                    Kembali
                </a>
                <button onclick="location.reload()" class="btn btn-info">
                    Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats - Compact Row -->
<div class="stats-row">
    <div class="stat-item stat-primary">
        <div class="stat-details">
            <div class="stat-value">{{ monthly_reports|length }}</div>
            <div class="stat-label">Total Bulan Ini</div>
        </div>
    </div>
    <div class="stat-item stat-success">
        <div class="stat-details">
            <div class="stat-value">
                {% set unique_locations = [] %}
                {% for report in monthly_reports %}
                    {% if report.Alamat and report.Alamat not in unique_locations %}
                        {% set _ = unique_locations.append(report.Alamat) %}
                    {% endif %}
                {% endfor %}
                {{ unique_locations|length }}
            </div>
            <div class="stat-label">Lokasi</div>
        </div>
    </div>
    <div class="stat-item stat-warning">
        <div class="stat-details">
            <div class="stat-value">
                {% set pending_count = monthly_reports|selectattr('Status', 'equalto', 'pending')|list|length %}
                {{ pending_count }}
            </div>
            <div class="stat-label">Pending</div>
        </div>
    </div>
    <div class="stat-item stat-info">
        <div class="stat-details">
            <div class="stat-value">
                {% set processed_count = monthly_reports|selectattr('Status', 'equalto', 'processed')|list|length %}
                {% set completed_count = monthly_reports|selectattr('Status', 'equalto', 'completed')|list|length %}
                {{ processed_count + completed_count }}
            </div>
            <div class="stat-label">Selesai</div>
        </div>
    </div>
</div>

<!-- Main Content - 2 Column Layout -->
<div class="content-grid">
    <!-- Left: Chart & Insights -->
    <div class="content-left">
        <!-- Trend Chart -->
        <div class="card compact-card">
            <div class="card-header compact-header">
                <h3 class="card-title">Tren 12 Bulan Terakhir</h3>
            </div>
            <div class="card-body compact-body">
                <canvas id="trendChart" height="160"></canvas>
            </div>
        </div>
        
        <!-- Quick Insights -->
        <div class="card compact-card">
            <div class="card-header compact-header">
                <h3 class="card-title">Insight Cepat</h3>
            </div>
            <div class="card-body compact-body">
                <div class="insights-compact">
                    <div class="insight-row">
                        <span class="insight-label">Rata-rata/bulan:</span>
                        <span class="insight-value">{{ yearly_stats.avg_per_month|default(0) }} laporan</span>
                    </div>
                    <div class="insight-row">
                        <span class="insight-label">Bulan tertinggi:</span>
                        <span class="insight-value highlight">{{ yearly_stats.max_month|default('N/A') }} ({{ yearly_stats.max_count|default(0) }})</span>
                    </div>
                    <div class="insight-row">
                        <span class="insight-label">Status bulan ini:</span>
                        <span class="insight-value">
                            {% if monthly_reports|length > yearly_stats.avg_per_month|default(0) %}
                                <span class="badge badge-warning">Di atas rata-rata</span>
                            {% elif monthly_reports|length < yearly_stats.avg_per_month|default(0) %}
                                <span class="badge badge-success">Di bawah rata-rata</span>
                            {% else %}
                                <span class="badge badge-info">Normal</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="insight-row">
                        <span class="insight-label">Total tahun {{ now.strftime('%Y') }}:</span>
                        <span class="insight-value">{{ yearly_stats.total_reports|default(0) }} laporan</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right: Top Locations & Height Distribution -->
    <div class="content-right">
        <!-- Top 5 Locations -->
        <div class="card compact-card">
            <div class="card-header compact-header">
                <h3 class="card-title">Top 5 Lokasi Rawan</h3>
            </div>
            <div class="card-body compact-body">
                <div class="top-locations">
                    {% if yearly_stats.top_locations and yearly_stats.top_locations|length > 0 %}
                        {% for location in yearly_stats.top_locations %}
                        <div class="location-compact">
                            <span class="location-number">{{ loop.index }}</span>
                            <span class="location-name">{{ location.location[:40] }}{% if location.location|length >= 40 %}...{% endif %}</span>
                            <span class="location-count">{{ location.count }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="location-compact">
                            <span class="location-number">-</span>
                            <span class="location-name">Tidak ada data</span>
                            <span class="location-count">0</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Height Distribution -->
        <div class="card compact-card">
            <div class="card-header compact-header">
                <h3 class="card-title">Distribusi Tinggi</h3>
            </div>
            <div class="card-body compact-body">
                <div class="height-distribution">
                    {% if yearly_stats.flood_heights and yearly_stats.flood_heights|length > 0 %}
                        {% for height, count in yearly_stats.flood_heights.items() %}
                        <div class="height-bar">
                            <span class="height-label">{{ height }}</span>
                            <div class="height-progress">
                                <div class="height-fill 
                                    {% if '10-20' in height %}fill-info
                                    {% elif '30-50' in height %}fill-warning
                                    {% elif '>50' in height %}fill-danger
                                    {% else %}fill-secondary{% endif %}" 
                                    style="width: {{ (count / yearly_stats.total_reports * 100)|int|default(0) }}%">
                                </div>
                            </div>
                            <span class="height-count">{{ count }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="height-bar">
                            <span class="height-label">Tidak ada data</span>
                            <div class="height-progress">
                                <div class="height-fill fill-secondary" style="width: 0%"></div>
                            </div>
                            <span class="height-count">0</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compact Monthly Table with Month Selector -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title" id="tableHeading">Detail Laporan Bulan {{ current_month_name }}</h3>
        <div class="header-actions" style="display:flex; align-items:center; gap:10px;">
            <select id="monthSelector" class="form-control form-control-sm" style="width:auto; min-width:160px;">
                {% for m in available_months %}
                <option value="{{ m }}" {% if m == displayed_month %}selected{% endif %}>
                    {% set parts = m.split('-') %}
                    {% set mn = ['','Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'] %}
                    {{ mn[parts[1]|int] }} {{ parts[0] }}
                </option>
                {% endfor %}
            </select>
            <span class="badge badge-primary" id="reportCountBadge">{{ monthly_reports|length }} Laporan</span>
        </div>
    </div>
    <div class="card-body">
        <div id="tableContainer">
            <!-- rendered by JS from allReports -->
        </div>
        <!-- Compact Info -->
        <div class="info-compact" style="margin-top:15px;">
            <span>Data diperbarui otomatis</span>
            <span>â€¢</span>
            <span>Update: {{ now.strftime('%d/%m/%Y %H:%M') }}</span>
        </div>
    </div>
</div>

<style>
/* Hero Section - Compact */
.hero-section-with-image {
    margin-bottom: 25px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.hero-image-container {
    position: relative;
    width: 100%;
    height: 250px;
    overflow: hidden;
}

.hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    animation: cinematicZoomIn 15s ease-out infinite;
}

@keyframes cinematicZoomIn {
    0% { transform: scale(1); }
    100% { transform: scale(1.08); }
}

.hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.25) 50%, rgba(0, 0, 0, 0.15) 100%);
}

.hero-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    width: 90%;
    max-width: 700px;
    z-index: 2;
}

.hero-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(3px 3px 8px rgba(0, 0, 0, 0.9))
            drop-shadow(1px 1px 4px rgba(0, 0, 0, 1))
            drop-shadow(0px 0px 20px rgba(255, 255, 255, 0.3));
}

.hero-subtitle {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.1rem;
    max-width: 600px;
    margin: 0 auto 18px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.hero-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

/* Compact Stats Row */
.stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

.stat-item {
    background: white;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-left: 4px solid #e5e7eb;
    transition: all 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.stat-primary { border-left-color: #3b82f6; }
.stat-success { border-left-color: #10b981; }
.stat-warning { border-left-color: #f59e0b; }
.stat-info { border-left-color: #06b6d4; }

.stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-details {
    flex: 1;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 0.85rem;
    color: #6b7280;
    font-weight: 500;
}

/* Content Grid - 2 Columns */
.content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 25px;
}

.content-left, .content-right {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Compact Cards */
.compact-card {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.compact-header {
    padding: 15px 20px;
    border-bottom: 1px solid #e5e7eb;
}

.compact-header .card-title {
    font-size: 1rem;
    margin: 0;
}

.compact-body {
    padding: 20px;
}

/* Insights Compact */
.insights-compact {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.insight-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 12px;
    background: #f9fafb;
    border-radius: 6px;
    font-size: 0.9rem;
}

.insight-label {
    color: #6b7280;
    font-weight: 500;
}

.insight-value {
    color: #1f2937;
    font-weight: 600;
}

.insight-value.highlight {
    color: #3b82f6;
}

/* Top Locations Compact */
.top-locations {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.location-compact {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f9fafb;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.location-compact:hover {
    background: #f0f9ff;
    transform: translateX(3px);
}

.location-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #06b6d4);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 700;
    flex-shrink: 0;
}

.location-name {
    flex: 1;
    font-size: 0.85rem;
    color: #374151;
    font-weight: 500;
}

.location-count {
    background: #3b82f6;
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Height Distribution */
.height-distribution {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.height-bar {
    display: grid;
    grid-template-columns: 140px 1fr 40px;
    align-items: center;
    gap: 10px;
}

.height-label {
    font-size: 0.85rem;
    color: #374151;
    font-weight: 500;
}

.height-progress {
    height: 22px;
    background: #e5e7eb;
    border-radius: 11px;
    overflow: hidden;
}

.height-fill {
    height: 100%;
    transition: width 0.5s ease;
}

.fill-info { background: linear-gradient(90deg, #0ea5e9, #06b6d4); }
.fill-warning { background: linear-gradient(90deg, #f59e0b, #fb923c); }
.fill-danger { background: linear-gradient(90deg, #ef4444, #f87171); }
.fill-secondary { background: linear-gradient(90deg, #6b7280, #9ca3af); }

.height-count {
    text-align: right;
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

/* Compact Table */
.table-compact {
    font-size: 0.9rem;
}

.table-compact thead th {
    padding: 10px;
    font-weight: 600;
    font-size: 0.85rem;
}

.table-compact tbody td {
    padding: 10px;
}

.cell-compact {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.cell-compact small {
    color: #9ca3af;
    font-size: 0.75rem;
}

.badge-sm {
    padding: 3px 8px;
    font-size: 0.75rem;
}

.map-link-compact {
    color: #3b82f6;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
}

.map-link-compact:hover {
    text-decoration: underline;
}

/* Info Compact */
.info-compact {
    margin-top: 15px;
    padding: 12px;
    background: #eff6ff;
    border-radius: 8px;
    border-left: 3px solid #3b82f6;
    font-size: 0.85rem;
    color: #1e40af;
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
}

/* Empty State Compact */
.empty-state-compact {
    text-align: center;
    padding: 40px 20px;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-radius: 12px;
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
}

.empty-state-compact h3 {
    color: #92400e;
    font-size: 1.3rem;
    margin-bottom: 8px;
}

.empty-state-compact p {
    color: #92400e;
    margin-bottom: 15px;
}

/* Month Selector */
#monthSelector {
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #374151;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.2s;
}
#monthSelector:hover,
#monthSelector:focus {
    border-color: #3b82f6;
    outline: none;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
}

/* Responsive */
@media (max-width: 1024px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .hero-title {
        font-size: 2rem;
    }
    
    .stats-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .stat-item {
        padding: 15px;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
    
    .hero-image-container {
        height: 200px;
    }
}

@media (max-width: 480px) {
    .stats-row {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// ========== DATA FROM SERVER ==========
const allReports = {{ all_reports|tojson }};

// ========== MONTH NAMES HELPER ==========
const MONTH_NAMES = ['','Januari','Februari','Maret','April','Mei','Juni',
                     'Juli','Agustus','September','Oktober','November','Desember'];

function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const parts = dateStr.split('-');
    if (parts.length !== 3) return dateStr;
    return `${parseInt(parts[2])} ${MONTH_NAMES[parseInt(parts[1])]} ${parts[0]}`;
}

function getHeightBadgeClass(height) {
    if (!height) return 'badge-secondary';
    if (height.includes('10-20')) return 'badge-info';
    if (height.includes('30-50') || height.includes('20-40') || height.includes('40-60')) return 'badge-warning';
    if (height.includes('>50') || height.includes('>60')) return 'badge-danger';
    return 'badge-secondary';
}

function getStatusBadge(status) {
    if (status === 'processed') return '<span class="badge badge-info badge-sm">PROSES</span>';
    if (status === 'completed') return '<span class="badge badge-success badge-sm">SELESAI</span>';
    return '<span class="badge badge-warning badge-sm">PENDING</span>';
}

// ========== RENDER TABLE ==========
function renderTable(selectedMonth) {
    const filtered = allReports.filter(r => r.month_year === selectedMonth);
    const container = document.getElementById('tableContainer');

    // Update heading
    const parts = selectedMonth.split('-');
    const heading = `Detail Laporan Bulan ${MONTH_NAMES[parseInt(parts[1])]} ${parts[0]}`;
    document.getElementById('tableHeading').textContent = heading;
    document.getElementById('reportCountBadge').textContent = filtered.length + ' Laporan';

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state-compact">
                <h3>Tidak ada laporan</h3>
                <p>Belum ada laporan banjir untuk ${MONTH_NAMES[parseInt(parts[1])]} ${parts[0]}</p>
                <a href="/lapor-banjir" class="btn btn-primary btn-sm">Buat Laporan</a>
            </div>`;
        return;
    }

    let rows = '';
    filtered.forEach((r, i) => {
        const height = r['Tinggi Banjir'] || '';
        const badgeClass = getHeightBadgeClass(height);
        const coordCell = (r.latitude && r.longitude)
            ? `<a href="https://www.google.com/maps?q=${r.latitude},${r.longitude}" target="_blank" class="map-link-compact" title="Lihat Peta">Lihat</a>`
            : '<span style="color:#999;">-</span>';
        const timeStr = r.report_time ? `<small>${r.report_time.substring(0,5)}</small>` : '';

        rows += `<tr>
            <td>${i + 1}</td>
            <td><div class="cell-compact">${formatDate(r.report_date)}${timeStr}</div></td>
            <td><div class="cell-compact">${(r.Alamat || '').substring(0, 45)}${(r.Alamat||'').length > 45 ? '...' : ''}</div></td>
            <td><span class="badge ${badgeClass} badge-sm">${height}</span></td>
            <td><div class="cell-compact">${r['Nama Pelapor'] || ''}</div></td>
            <td>${getStatusBadge(r.Status)}</td>
            <td>${coordCell}</td>
        </tr>`;
    });

    container.innerHTML = `<div class="table-responsive">
        <table class="table table-compact">
            <thead><tr>
                <th>No</th><th>Tanggal</th><th>Lokasi</th>
                <th>Tinggi</th><th>Pelapor</th><th>Status</th><th>Koordinat</th>
            </tr></thead>
            <tbody>${rows}</tbody>
        </table></div>`;
}

// ========== MONTH SELECTOR ==========
document.addEventListener('DOMContentLoaded', function() {
    const selector = document.getElementById('monthSelector');

    // Initial render
    if (selector && selector.value) {
        renderTable(selector.value);
    }

    // On change
    if (selector) {
        selector.addEventListener('change', function() {
            renderTable(this.value);
        });
    }

    // ========== TREND CHART (12 Bulan) ==========
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;

    const chartLabels = {{ yearly_stats.chart_labels|default([])|tojson }};
    const chartData   = {{ yearly_stats.chart_data|default([])|tojson }};

    if (chartLabels.length === 0) {
        ctx.parentElement.innerHTML = `<div class="text-center p-4">
            <p class="text-muted">Tidak ada data untuk ditampilkan</p>
            <small>Belum ada laporan dalam 12 bulan terakhir</small></div>`;
        return;
    }

    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Laporan',
                data: chartData,
                backgroundColor: chartData.map(v => v > 0 ? 'rgba(59, 130, 246, 0.7)' : 'rgba(59, 130, 246, 0.15)'),
                borderColor: '#3b82f6',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 10,
                    titleFont: { size: 12 },
                    bodyFont: { size: 11 },
                    callbacks: {
                        label: function(ctx) { return 'Laporan: ' + ctx.parsed.y; }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        stepSize: Math.max(1, Math.ceil(Math.max(...chartData) / 5)),
                        font: { size: 10 }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                    ticks: { font: { size: 10 } },
                    grid: { display: false }
                }
            }
        }
    });
});
</script>
{% endblock %}