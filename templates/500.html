{% extends "layout.html" %}

{% block content %}
<div class="error-page">
    <div class="error-container">
        <div class="error-code">500</div>
        <h1 class="error-title">Kesalahan Server Internal</h1>
        <p class="error-message">
            Terjadi kesalahan pada server kami. Tim teknis telah diberitahu dan sedang memperbaiki masalah.
            Silakan coba lagi beberapa saat atau hubungi dukungan teknis jika masalah berlanjut.
        </p>
        
        <div class="error-details">
            <div class="alert alert-warning">
                <h5>Informasi Kesalahan</h5>
                <p><strong>Waktu:</strong> {{ now.strftime('%d %B %Y, %H:%M:%S') if now else 'Tidak diketahui' }}</p>
                <p><strong>Kode Error:</strong> 500 - Internal Server Error</p>
                <p><strong>ID Referensi:</strong> ERR-{{ now.strftime('%Y%m%d%H%M%S') if now else '00000000000000' }}</p>
            </div>
        </div>
        
        <div class="error-actions">
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                Kembali ke Beranda
            </a>
            <button onclick="location.reload()" class="btn btn-secondary">
                Coba Muat Ulang Halaman
            </button>
            <a href="{{ url_for('panduan') }}" class="btn btn-outline-secondary">
                Buka Panduan
            </a>
        </div>
        
        <div class="error-help mt-4">
            <div class="row">
                <div class="col-6">
                    <div class="help-section">
                        <h5>Langkah Pemecahan Masalah</h5>
                        <ol class="troubleshooting-list">
                            <li>Refresh halaman ini (tekan F5 atau Ctrl+R)</li>
                            <li>Clear cache dan cookies browser Anda</li>
                            <li>Coba akses dari browser berbeda</li>
                            <li>Tunggu beberapa menit lalu coba lagi</li>
                            <li>Periksa koneksi internet Anda</li>
                        </ol>
                    </div>
                </div>
                <div class="col-6">
                    <div class="help-section">
                        <h5>Butuh Bantuan Cepat?</h5>
                        <div class="contact-info">
                            <p><strong>Email Dukungan:</strong><br>
                            <a href="mailto:tyarawahyusaputra@gmail.com">tyarawahyusaputra@gmail.com</a></p>
                            
                            <p><strong>Telepon:</strong><br>
                            <a href="tel:085156959561">085156959561</a></p>
                            
                            <p><strong>Jam Operasional:</strong><br>
                            08:00 - 17:00 (WIB)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="error-report mt-4">
            <details>
                <summary>Laporkan Masalah Ini</summary>
                <div class="report-form">
                    <p>Jika masalah berlanjut, silakan laporkan dengan detail berikut:</p>
                    <div class="report-details">
                        <p><strong>URL Halaman:</strong> <code>{{ request.url if request else 'Tidak diketahui' }}</code></p>
                        <p><strong>Browser:</strong> <span id="browserInfo">Mendeteksi...</span></p>
                        <p><strong>Waktu Kejadian:</strong> <span id="errorTime">{{ now.strftime('%Y-%m-%d %H:%M:%S') if now else '' }}</span></p>
                    </div>
                    <button onclick="copyErrorDetails()" class="btn btn-sm btn-outline-secondary mt-2" id="copyErrorBtn">
                        Salin Detail Error
                    </button>
                </div>
            </details>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>
{% endblock %}

{% block extra_css %}
<style>
.error-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 70vh;
    padding: 40px 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.error-container {
    text-align: center;
    max-width: 900px;
    padding: 50px;
    background: white;
    border-radius: 15px;
    border: 1px solid #dee2e6;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
}

.error-code {
    font-size: 8rem;
    font-weight: 900;
    color: #dc3545;
    line-height: 1;
    margin-bottom: 20px;
    text-shadow: 3px 3px 0 rgba(220, 53, 69, 0.1);
}

.error-title {
    font-size: 2.2rem;
    color: #333333;
    margin-bottom: 20px;
    font-weight: 600;
}

.error-message {
    font-size: 1.2rem;
    color: #6c757d;
    margin-bottom: 40px;
    line-height: 1.6;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
}

.error-details {
    max-width: 600px;
    margin: 30px auto;
}

.error-details .alert {
    text-align: left;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #ffc107;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.error-details h5 {
    color: #856404;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.error-details p {
    margin: 8px 0;
    color: #6c757d;
}

.error-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 40px 0;
}

.error-actions .btn {
    padding: 12px 30px;
    font-size: 1.1rem;
    border-radius: 8px;
    min-width: 200px;
}

.error-help {
    padding: 30px;
    background: rgba(220, 53, 69, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(220, 53, 69, 0.1);
    margin-top: 30px;
}

.error-help .row {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
}

.error-help .col-6 {
    flex: 1;
    min-width: 300px;
}

.help-section {
    text-align: left;
    padding: 20px;
    background: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    height: 100%;
}

.help-section h5 {
    color: #0d6efd;
    margin-bottom: 20px;
    font-size: 1.2rem;
    padding-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
}

.troubleshooting-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.troubleshooting-list li {
    padding: 8px 0;
    color: #6c757d;
    position: relative;
    padding-left: 25px;
}

.troubleshooting-list li::before {
    content: "✓";
    color: #198754;
    position: absolute;
    left: 0;
    font-weight: bold;
}

.contact-info p {
    margin: 15px 0;
    color: #6c757d;
}

.contact-info a {
    color: #0d6efd;
    text-decoration: none;
    word-break: break-all;
}

.contact-info a:hover {
    text-decoration: underline;
}

.contact-info strong {
    color: #333333;
    display: block;
    margin-bottom: 5px;
}

.error-report {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
}

.error-report details {
    background: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    overflow: hidden;
}

.error-report summary {
    padding: 15px 20px;
    background: rgba(0, 0, 0, 0.02);
    cursor: pointer;
    color: #0d6efd;
    font-weight: 500;
    list-style: none;
    position: relative;
}

.error-report summary::-webkit-details-marker {
    display: none;
}

.error-report summary::after {
    content: "+";
    position: absolute;
    right: 20px;
    font-size: 1.5rem;
    font-weight: 300;
    transition: transform 0.3s ease;
}

.error-report details[open] summary::after {
    content: "−";
}

.report-form {
    padding: 20px;
    text-align: left;
    background: rgba(0, 0, 0, 0.01);
}

.report-form p {
    color: #6c757d;
    margin-bottom: 15px;
}

.report-details {
    background: rgba(0, 0, 0, 0.05);
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 15px;
}

.report-details p {
    margin: 8px 0;
    font-family: monospace;
    font-size: 0.9rem;
}

.report-details code {
    background: rgba(0, 0, 0, 0.1);
    padding: 2px 8px;
    border-radius: 4px;
    color: #333333;
}

@media (max-width: 768px) {
    .error-code {
        font-size: 6rem;
    }
    
    .error-title {
        font-size: 1.8rem;
    }
    
    .error-message {
        font-size: 1.1rem;
    }
    
    .error-actions {
        flex-direction: column;
        align-items: center;
    }
    
    .error-actions .btn {
        width: 100%;
        max-width: 300px;
    }
    
    .error-help .col-6 {
        min-width: 100%;
    }
    
    .error-container {
        padding: 30px 20px;
    }
}

@media (max-width: 480px) {
    .error-code {
        font-size: 5rem;
    }
    
    .error-title {
        font-size: 1.5rem;
    }
    
    .error-container {
        padding: 20px 15px;
    }
    
    .help-section {
        padding: 15px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Detect browser info
    const browserInfo = document.getElementById('browserInfo');
    if (browserInfo) {
        browserInfo.textContent = detectBrowser();
    }
    
    // Auto-refresh suggestion after 30 seconds
    setTimeout(() => {
        const reloadBtn = document.querySelector('button[onclick="location.reload()"]');
        if (reloadBtn) {
            reloadBtn.innerHTML = '<strong>Coba Muat Ulang (Disarankan)</strong>';
            reloadBtn.classList.add('pulse-animation');
        }
    }, 30000);
    
    // Log 500 error for analytics
    console.error('500 Error: Internal Server Error -', window.location.pathname);
    
    // Error tracking (removed localStorage usage)
    try {
        const errorData = {
            type: '500',
            path: window.location.pathname,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent.substring(0, 100),
            browser: detectBrowser(),
            referrer: document.referrer || 'direct'
        };
        
        // In a real app, send this to your error tracking service
        console.log('Server Error logged:', errorData);
        
    } catch (e) {
        // Silently fail for error logging
    }
});

function detectBrowser() {
    const userAgent = navigator.userAgent;
    let browser = "Browser Tidak Dikenal";
    
    if (userAgent.indexOf("Firefox") > -1) {
        browser = "Mozilla Firefox";
    } else if (userAgent.indexOf("Chrome") > -1) {
        browser = "Google Chrome";
    } else if (userAgent.indexOf("Safari") > -1) {
        browser = "Safari";
    } else if (userAgent.indexOf("Edge") > -1) {
        browser = "Microsoft Edge";
    } else if (userAgent.indexOf("Opera") > -1 || userAgent.indexOf("OPR") > -1) {
        browser = "Opera";
    } else if (userAgent.indexOf("Trident") > -1) {
        browser = "Internet Explorer";
    }
    
    return browser;
}

function copyErrorDetails() {
    const copyBtn = document.getElementById('copyErrorBtn');
    const originalText = copyBtn ? copyBtn.textContent : '';
    
    const errorDetails = {
        url: window.location.href,
        browser: detectBrowser(),
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
        errorCode: '500',
        errorId: 'ERR-' + new Date().toISOString().replace(/[^0-9]/g, '').substring(0, 14)
    };
    
    const textToCopy = `LAPORAN ERROR SISTEM BANJIR\n` +
                    `============================\n` +
                    `Waktu: ${errorDetails.timestamp}\n` +
                    `URL: ${errorDetails.url}\n` +
                    `Browser: ${errorDetails.browser}\n` +
                    `Kode Error: ${errorDetails.errorCode}\n` +
                    `ID Error: ${errorDetails.errorId}\n` +
                    `User Agent: ${errorDetails.userAgent}\n` +
                    `\nDeskripsi Masalah:\n` +
                    `[Silakan jelaskan apa yang Anda lakukan sebelum error terjadi]`;
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showToast('Detail error berhasil disalin ke clipboard', 'success');
        
        if (copyBtn) {
            copyBtn.textContent = '✓ Berhasil Disalin';
            copyBtn.classList.remove('btn-outline-secondary');
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-secondary');
            }, 2000);
        }
    }).catch(err => {
        showToast('Gagal menyalin ke clipboard. Silakan salin manual.', 'error');
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const typeClasses = {
        'success': 'text-bg-success',
        'error': 'text-bg-danger',
        'warning': 'text-bg-warning',
        'info': 'text-bg-info'
    };
    
    const toastHtml = `
        <div id="${toastId}" class="toast ${typeClasses[type] || 'text-bg-info'}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Sistem Banjir</strong>
                <small>Baru saja</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    if (toastContainer) {
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        
        // Check if Bootstrap is available
        if (typeof bootstrap !== 'undefined') {
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        } else {
            // Fallback for no Bootstrap
            toastElement.style.cssText = `
                position: relative;
                margin-bottom: 10px;
                animation: slideIn 0.3s ease;
            `;
            
            setTimeout(() => {
                toastElement.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toastElement.remove(), 300);
            }, 3000);
        }
    }
}

// Add CSS for pulse animation
const style = document.createElement('style');
style.textContent = `
@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
}

.pulse-animation {
    animation: pulse 2s infinite;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}