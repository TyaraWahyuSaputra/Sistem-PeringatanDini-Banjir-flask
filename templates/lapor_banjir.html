{% extends "layout.html" %}

{% block content %}
<!-- Hero Section dengan Background Image -->
<div class="hero-section" style="background: url('{{ url_for('static', filename='image/hero_section.jpg') }}');">
    <div class="hero-content-wrapper">
        <h1 class="hero-title">LAPOR BANJIR</h1>
        <p class="hero-subtitle">
            Laporkan kondisi banjir di sekitar Anda untuk membantu sistem peringatan dini
        </p>
    </div>
</div>
                            <!-- Flash Messages Display -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages-container mb-3">
    {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'warning' }} alert-dismissible fade show" role="alert">
        <strong>
            {% if category == 'success' %}✅ Berhasil!{% elif category == 'error' %}❌ Gagal!{% else %}⚠️ Perhatian!{% endif %}
        </strong>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
{% endif %}
{% endwith %}
<div class="row">
    <div class="col-8">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Form Laporan Banjir</h2>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('lapor_banjir') }}" enctype="multipart/form-data" id="reportForm" novalidate>
                    <!-- Hidden Token untuk Prevent Duplicate Submission -->
                    <input type="hidden" name="form_token" value="{{ form_token }}">
                    <!-- Alamat -->
                    <div class="form-group">
                        <label for="address" class="form-label">
                            Alamat Lengkap <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                            class="form-control" 
                            id="address" 
                            name="address" 
                            placeholder="Contoh: Kelurahan Ngasem, Kecamatan Colomadu, Kota Karanganyar, Jawa Tengah"
                            required
                            minlength="10"
                            maxlength="200">
                    <div class="invalid-feedback" id="addressError">
                        Alamat minimal 10 karakter (isi lokasi selengkap mungkin)
                    </div>
                <div class="form-text">
                    Gunakan nama wilayah administratif yang jelas agar lokasi dapat ditampilkan di peta
                </div>
                </div>
                    <!-- Tinggi Banjir -->
                    <div class="form-group">
                        <label for="flood_height" class="form-label">
                            Tinggi Banjir <span class="text-danger">*</span>
                        </label>
                        <select class="form-control" id="flood_height" name="flood_height" required>
                            <option value="" selected disabled>Pilih tinggi banjir</option>
                            <option value="Setinggi mata kaki (10-20 cm)">Setinggi mata kaki (10-20 cm)</option>
                            <option value="Setinggi betis (20-40 cm)">Setinggi betis (20-40 cm)</option>
                            <option value="Setinggi lutut (40-60 cm)">Setinggi lutut (40-60 cm)</option>
                            <option value="Lebih dari lutut (>60 cm)">Lebih dari lutut (>60 cm)</option>
                        </select>
                        <div class="invalid-feedback" id="heightError">
                            Silakan pilih tinggi banjir
                        </div>
                        <div class="form-text">Pilih estimasi ketinggian air banjir</div>
                    </div>

                    <div class="row">
                        <!-- Nama Pelapor -->
                        <div class="col-6">
                            <div class="form-group">
                                <label for="reporter_name" class="form-label">
                                    Nama Pelapor <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                    class="form-control" 
                                    id="reporter_name" 
                                    name="reporter_name" 
                                    placeholder="Nama lengkap"
                                    required
                                    minlength="3"
                                    maxlength="50">
                                <div class="invalid-feedback" id="nameError">
                                    Nama harus diisi minimal 3 karakter
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nomor Telepon -->
                        <div class="col-6">
                            <div class="form-group">
                                <label for="reporter_phone" class="form-label">
                                    Nomor Telepon (Opsional)
                                </label>
                                <input type="tel" 
                                    class="form-control" 
                                    id="reporter_phone" 
                                    name="reporter_phone" 
                                    placeholder="081234567890"
                                    pattern="^(\+62|62|0)8[1-9][0-9]{6,11}$">
                                <div class="invalid-feedback" id="phoneError">
                                    Format nomor telepon tidak valid (10-13 angka)
                                </div>
                                <div class="form-text">Untuk verifikasi jika diperlukan</div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Foto -->
                    <div class="form-group">
                        <label for="photo" class="form-label">
                            Foto Kondisi Banjir <span class="text-danger">*</span>
                        </label>
                        <input type="file" 
                            class="form-control" 
                            id="photo" 
                            name="photo" 
                            accept="image/*" 
                            required
                            data-preview="photoPreview">
                        <div class="invalid-feedback" id="photoError">
                            Silakan unggah foto kondisi banjir
                        </div>
                        <div class="form-text">
                            Unggah foto kondisi banjir (JPG, PNG, GIF, maks. 5MB)
                        </div>
                        
                        <!-- Photo Preview -->
                        <div class="photo-preview mt-3" id="photoPreview" style="display: none;">
                            <img src="" alt="Preview" class="img-thumbnail" 
                                 style="max-width: 300px; cursor: pointer;" 
                                 onclick="showPhotoModal(this.src)"
                                 title="Klik untuk melihat foto lebih besar">
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-primary me-2" onclick="showPhotoModal(document.querySelector('#photoPreview img').src)">
                                    <i class="fas fa-search-plus"></i> Lihat Foto
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removePhoto()">
                                    <i class="fas fa-trash"></i> Hapus Foto
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Terms -->
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="terms" required>
                            <label class="form-check-label" for="terms">
                                Saya menyatakan bahwa informasi yang diberikan adalah benar dan dapat dipertanggungjawabkan
                            </label>
                            <div class="invalid-feedback text-danger fw-semibold" id="termsError">
                                Anda harus menyetujui pernyataan ini
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="form-group mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            Kirim Laporan
                        </button>
                        <button type="reset" class="btn btn-secondary btn-lg" onclick="resetForm()">
                            Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-4">
        <!-- Panduan Singkat -->
        <div class="card mb-20">
            <div class="card-header">
                <h2 class="card-title">Panduan</h2>
            </div>
            <div class="card-body">
                <ol>
                    <li>Isi alamat dengan detail</li>
                    <li>Pilih estimasi tinggi banjir</li>
                    <li>Masukkan data diri</li>
                    <li>Unggah foto kondisi</li>
                    <li>Pastikan koneksi internet stabil</li>
                </ol>
            </div>
        </div>
        
        <!-- Status Upload -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Status</h2>
            </div>
            <div class="card-body">
                <div id="uploadStatus">
                    <p class="text-muted">Form siap diisi</p>
                </div>
                <div class="progress mt-2" style="display: none;" id="uploadProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>


<!-- Modal untuk Preview Foto Besar -->
<div id="photoModal" class="modal fade" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview Foto Banjir</h5>
                <button type="button" class="btn-close" onclick="closePhotoModal()"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhotoImg" src="" alt="Foto Banjir" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePhotoModal()">Tutup</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Hero Section untuk Lapor Banjir */
.hero-section {
    position: relative;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    text-align: center;
    padding: 50px 24px;
    border-radius: 20px;
    margin-bottom: 32px;
    border: 1px solid var(--border);
    backdrop-filter: blur(10px);
    overflow: hidden;
    color: white;
    min-height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* Cinematic Zoom Effect - Smooth and Slow */
.hero-section::before {
    content: '';
    position: absolute;
    top: -5%;
    left: -5%;
    width: 110%;
    height: 110%;
    background-image: inherit;
    background-size: cover;
    background-position: center;
    animation: cinematicZoomIn 15s ease-out infinite;
    z-index: 0;
}

.hero-section::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.4));
    z-index: 1;
}

@keyframes cinematicZoomIn {
    0% {
        transform: scale(1);
    }
    100% {
        transform: scale(1.08);
    }
}

.hero-content-wrapper {
    z-index: 2;
    position: relative;
}

/* Hero Title - Styling Lengkap dari Index */
.hero-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 20px;
    letter-spacing: -1px;
    background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
    filter: drop-shadow(3px 3px 8px rgba(0, 0, 0, 0.9))
            drop-shadow(1px 1px 4px rgba(0, 0, 0, 1))
            drop-shadow(0 0 20px rgba(59, 130, 246, 0.5));
    line-height: 1.2;
}

/* Hero Subtitle - Styling Lengkap dari Index */
.hero-subtitle {
    font-size: 1.1rem;
    max-width: 800px;
    margin: 0 auto 30px;
    line-height: 1.8;
    color: #FFFFFF !important;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.9), 
                1px 1px 3px rgba(0, 0, 0, 1),
                0 0 15px rgba(0, 0, 0, 0.6);
    filter: brightness(1.1);
}

.photo-preview {
    text-align: center;
    padding: 15px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    background: #f8f9fa;
}

.img-thumbnail {
    border: 1px solid #dee2e6;
    padding: 5px;
    background: white;
    max-height: 200px;
    object-fit: contain;
}

#submitBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
}

.btn.btn-primary:disabled {
    background: #6c757d;
    border-color: #6c757d;

}

.form-check-label {
    color: #6c757d;
    font-size: 0.9rem;
    line-height: 1.4;
}

.invalid-feedback {
    display: none;
}

.was-validated .form-control:invalid ~ .invalid-feedback,
.was-validated .form-check-input:invalid ~ .invalid-feedback {
    display: block;
}

.form-control:invalid, .form-check-input:invalid {
    border-color: #dc3545;
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Toast animation */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@media (max-width: 768px) {
    .hero-section {
        padding: 40px 16px;
        min-height: 250px;
    }
    
    .hero-title {
        font-size: 2rem;
    }
    
    .hero-subtitle {
        font-size: 1rem;
    }
    
    .col-8, .col-6, .col-4 {
        width: 100%;
    }
    
    .row .col-6 {
        margin-bottom: 15px;
    }
}

/* Photo Modal Styles */
#photoModal.show {
    display: block !important;
}

#photoModal .modal-dialog {
    max-width: 90%;
    margin: 1.75rem auto;
}

#photoModal .modal-content {
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

#photoModal .modal-body {
    padding: 2rem;
    background: #f8f9fa;
}

#photoModal .modal-body img {
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
    outline: 0;
}

body.modal-open {
    overflow: hidden;
}

/* Photo Preview Enhancement */
.photo-preview img {
    transition: transform 0.2s;
    border: 3px solid #198754;
}

.photo-preview img:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

/* Toast Enhancement untuk Error/Warning */
.toast.text-bg-danger,
.toast.text-bg-warning {
    border: 3px solid currentColor;
    box-shadow: 0 8px 24px rgba(220, 53, 69, 0.3);
    font-size: 1.05rem;
}

.toast.text-bg-danger .toast-header,
.toast.text-bg-warning .toast-header {
    font-weight: 600;
    font-size: 1.1rem;
}

.toast.text-bg-danger .toast-body,
.toast.text-bg-warning .toast-body {
    font-weight: 500;
    padding: 1rem;
    line-height: 1.6;
}

/* Animation untuk menarik perhatian */
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.toast.text-bg-danger,
.toast.text-bg-warning {
    animation: pulse 0.5s ease-in-out 2;
}
</style>

<!-- Modal untuk Preview Foto Besar -->
<div id="photoModal" class="modal fade" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview Foto Banjir</h5>
                <button type="button" class="btn-close" onclick="closePhotoModal()"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhotoImg" src="" alt="Foto Banjir" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePhotoModal()">Tutup</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportForm');
    const submitBtn = document.getElementById('submitBtn');
    const photoInput = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const photoImg = photoPreview.querySelector('img');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadStatus = document.getElementById('uploadStatus');
    
    // Real-time validation
    const fields = ['address', 'flood_height', 'reporter_name', 'reporter_phone'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                validateField(this);
            });
            field.addEventListener('change', function() {
                validateField(this);
            });
        }
    });
    
    // Photo preview
    photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file
            const errors = validateFile(file);
            if (errors.length > 0) {
                showToast(errors.join('<br>'), 'error');
                photoInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                photoImg.src = e.target.result;
                photoPreview.style.display = 'block';
                validateField(photoInput);
            };
            reader.readAsDataURL(file);
        } else {
            photoPreview.style.display = 'none';
            photoImg.src = '';
        }
    });
    
    // Form validation on submit
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        // Prevent double submission
        if (submitBtn.disabled) {
            console.log('Form already being submitted, ignoring');
        return;
        }
        // Validate all fields SEBELUM disable button
        let isValid = true;
        
        // Required fields
        const requiredFields = ['address', 'flood_height', 'reporter_name', 'photo', 'terms'];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !validateField(field)) {
                isValid = false;
            }
        });
        
        // Optional phone validation
        const phoneField = document.getElementById('reporter_phone');
        if (phoneField && phoneField.value && !validateField(phoneField)) {
            isValid = false;
        }
        
        if (!isValid) {
            // FIXED: Re-enable button jika validasi gagal
            submitBtn.disabled = false;
            submitBtn.textContent = 'Kirim Laporan';
            showToast('Harap perbaiki kesalahan pada form sebelum mengirim', 'error');
            form.classList.add('was-validated');
            return;
        }
        
        // FIXED: Disable button HANYA setelah validasi sukses
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengirim...';
        
        if (uploadProgress) {
            uploadProgress.style.display = 'block';
            const progressBar = uploadProgress.querySelector('.progress-bar');
            progressBar.style.width = '30%';
        }
        
        if (uploadStatus) {
            uploadStatus.innerHTML = '<p class="text-primary">Mengirim laporan...</p>';
        }
        
        try {
            // Simulate upload progress
            simulateUploadProgress();
            
            // Prepare form data
            const formData = new FormData(form);
            
            // Send request
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (uploadProgress) {
                const progressBar = uploadProgress.querySelector('.progress-bar');
                progressBar.style.width = '100%';
            }
            
            // FIXED: Server redirects (PRG pattern), so just submit normally
            if (response.redirected || response.ok) {
                // Follow redirect and reload page to show flash messages
                showToast('Laporan berhasil dikirim! Halaman akan dimuat ulang...', 'success');
                if (uploadStatus) {
                    uploadStatus.innerHTML = '<p class="text-success">✅ Laporan berhasil dikirim</p>';
                }
                
                // Reload page to show flash messages from server
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
        } catch (error) {
            console.error('Error submitting form:', error);
            showToast(`Gagal mengirim laporan: ${error.message}`, 'error');
            
            if (uploadStatus) {
                uploadStatus.innerHTML = '<p class="text-danger"> Gagal mengirim laporan</p>';
            }
            
        } finally {
        // Re-enable button only on error (success will redirect)
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Kirim Laporan';
                if (uploadProgress) {
                    uploadProgress.style.display = 'none';
                    const progressBar = uploadProgress.querySelector('.progress-bar');
                    progressBar.style.width = '0%';
                }
            }, 1000);
        }
    });
    
    // Form reset
    window.resetForm = function() {
        form.reset();
        form.classList.remove('was-validated');
        photoPreview.style.display = 'none';
        photoImg.src = '';
        photoInput.value = '';
        
        // Reset validation states
        const fields = form.querySelectorAll('.form-control, .form-check-input');
        fields.forEach(field => {
            field.classList.remove('is-valid', 'is-invalid');
        });
        
        submitBtn.disabled = false;
        submitBtn.textContent = 'Kirim Laporan';
        
        // Focus on first field
        document.getElementById('address').focus();
    };
    
    // Remove photo function
    window.removePhoto = function() {
        photoInput.value = '';
        photoPreview.style.display = 'none';
        photoImg.src = '';
        validateField(photoInput);
    };
});

function validateField(field) {
    const errorElement = document.getElementById(field.id + 'Error');
    
    // Clear previous validation
    field.classList.remove('is-valid', 'is-invalid');
    if (errorElement) {
        errorElement.style.display = 'none';
    }
    
    // Check if field is required and empty
    if (field.hasAttribute('required') && !field.value.trim()) {
        field.classList.add('is-invalid');
        if (errorElement) {
            errorElement.textContent = field.getAttribute('data-error') || 'Field ini wajib diisi';
            errorElement.style.display = 'block';
        }
        return false;
    }
    
    // Special validation for file input
    if (field.type === 'file') {
        if (!field.files || field.files.length === 0) {
            field.classList.add('is-invalid');
            if (errorElement) {
                errorElement.textContent = 'Silakan unggah foto kondisi banjir';
                errorElement.style.display = 'block';
            }
            return false;
        }
        
        const file = field.files[0];
        const errors = validateFile(file);
        if (errors.length > 0) {
            field.classList.add('is-invalid');
            if (errorElement) {
                errorElement.textContent = errors[0];
                errorElement.style.display = 'block';
            }
            return false;
        }
    }
    
    // Pattern validation
    if (field.hasAttribute('pattern')) {
        const pattern = new RegExp(field.getAttribute('pattern'));
        if (field.value && !pattern.test(field.value)) {
            field.classList.add('is-invalid');
            if (errorElement) {
                errorElement.textContent = field.getAttribute('data-pattern-error') || 'Format tidak valid';
                errorElement.style.display = 'block';
            }
            return false;
        }
    }
    
    // Length validation
    if (field.hasAttribute('minlength')) {
        const minLength = parseInt(field.getAttribute('minlength'));
        if (field.value.length < minLength) {
            field.classList.add('is-invalid');
            if (errorElement) {
                errorElement.textContent = `Minimal ${minLength} karakter`;
                errorElement.style.display = 'block';
            }
            return false;
        }
    }
    
    if (field.hasAttribute('maxlength')) {
        const maxLength = parseInt(field.getAttribute('maxlength'));
        if (field.value.length > maxLength) {
            field.classList.add('is-invalid');
            if (errorElement) {
                errorElement.textContent = `Maksimal ${maxLength} karakter`;
                errorElement.style.display = 'block';
            }
            return false;
        }
    }
    
    // Checkbox validation
    if (field.type === 'checkbox' && field.required && !field.checked) {
        field.classList.add('is-invalid');
        if (errorElement) {
            errorElement.textContent = 'Anda harus menyetujui pernyataan ini';
            errorElement.style.display = 'block';
        }
        return false;
    }
    
    // Select validation
    if (field.tagName === 'SELECT' && field.required && !field.value) {
        field.classList.add('is-invalid');
        if (errorElement) {
            errorElement.textContent = 'Silakan pilih opsi yang tersedia';
            errorElement.style.display = 'block';
        }
        return false;
    }
    
    // If all validations pass
    if (field.value || field.type === 'file' || field.type === 'checkbox') {
        field.classList.add('is-valid');
    }
    
    return true;
}

function validateFile(file) {
    const errors = [];
    
    if (!file) return ['File tidak ditemukan'];
    
    // Check file size (5MB)
    const maxSize = 5 * 1024 * 1024; // 5MB in bytes
    if (file.size > maxSize) {
        errors.push('Ukuran foto maksimal 5MB');
    }
    
    // Check file type
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        errors.push('Format foto harus JPG, PNG, atau GIF');
    }
    
    return errors;
}

function simulateUploadProgress() {
    const progressBar = document.querySelector('#uploadProgress .progress-bar');
    if (!progressBar) return;
    
    let width = 30;
    const interval = setInterval(() => {
        if (width < 90) {
            width += Math.random() * 10;
            progressBar.style.width = width + '%';
        } else {
            clearInterval(interval);
        }
    }, 300);
}

// Toast notification function - FIXED: Custom delay untuk error messages
function showToast(message, type = 'info', customDelay = null) {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const typeClasses = {
        'success': 'text-bg-success',
        'error': 'text-bg-danger',
        'warning': 'text-bg-warning',
        'info': 'text-bg-info'
    };
    
    // FIXED: Error dan warning lebih lama (10 detik), success/info normal (5 detik)
    let delay = customDelay;
    if (delay === null) {
        if (type === 'error' || type === 'warning') {
            delay = 10000; // 10 detik untuk error/warning
        } else {
            delay = 5000;  // 5 detik untuk success/info
        }
    }
    
    const toastHtml = `
        <div id="${toastId}" class="toast ${typeClasses[type] || 'text-bg-info'}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">
                    ${type === 'error' ? '⚠️ Perhatian' : type === 'warning' ? '⚠️ Peringatan' : type === 'success' ? '✅ Berhasil' : 'ℹ️ Informasi'}
                </strong>
                <small>Baru saja</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    if (toastContainer) {
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        
        // Check if Bootstrap is available
        if (typeof bootstrap !== 'undefined') {
            const toast = new bootstrap.Toast(toastElement, { 
                delay: delay,
                autohide: true 
            });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        } else {
            // Fallback for no Bootstrap
            toastElement.style.cssText = `
                position: relative;
                margin-bottom: 10px;
                animation: slideIn 0.3s ease;
            `;
            
            setTimeout(() => {
                toastElement.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toastElement.remove(), 300);
            }, delay);
        }
    } else {
        // Fallback alert if no toast container
        alert(message);
    }
}


// ADDED: Function untuk show/hide photo modal
function showPhotoModal(imageSrc) {
    const modal = document.getElementById('photoModal');
    const modalImg = document.getElementById('modalPhotoImg');
    
    if (modal && modalImg && imageSrc) {
        modalImg.src = imageSrc;
        modal.style.display = 'block';
        modal.classList.add('show');
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'photoModalBackdrop';
        document.body.appendChild(backdrop);
        document.body.classList.add('modal-open');
        
        // Close on backdrop click
        backdrop.addEventListener('click', closePhotoModal);
        
        // Close on ESC key
        document.addEventListener('keydown', function escHandler(e) {
            if (e.key === 'Escape') {
                closePhotoModal();
                document.removeEventListener('keydown', escHandler);
            }
        });
    }
}

function closePhotoModal() {
    const modal = document.getElementById('photoModal');
    const backdrop = document.getElementById('photoModalBackdrop');
    
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
    }
    
    if (backdrop) {
        backdrop.remove();
    }
    
    document.body.classList.remove('modal-open');
}
</script>

<!-- Modal untuk Preview Foto Besar -->
<div id="photoModal" class="modal fade" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview Foto Banjir</h5>
                <button type="button" class="btn-close" onclick="closePhotoModal()"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalPhotoImg" src="" alt="Foto Banjir" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePhotoModal()">Tutup</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}